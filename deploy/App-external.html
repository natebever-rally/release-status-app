<!DOCTYPE html>
<html>
<head>
    <title>ReleaseSummary</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.getContext().getTimeboxScope()?this.onTimeboxScopeChange():this.releasecombo=this.add({xtype:"rallyreleasecombobox",listeners:{scope:this,select:this._onReleaseChange,ready:this._onReleaseChange}})},loadData:async function(t,e,a,s){Ext.getBody().mask("Loading...");const i=Ext.create("Rally.data.wsapi.Store",{model:t,fetch:a,limit:1/0,filters:[this.timeboxFilters]}),n=await i.load();return Ext.getBody().unmask(),this.reduceToFinishedItems(n,e,s)},loadAllData:async function(){const t={defects:await this.loadData("Defect","State",["PlanEstimate","State"],["Closed"]),stories:await this.loadData("HierarchicalRequirement","ScheduleState",["PlanEstimate","ScheduleState"],["Accepted","Released"]),testSets:await this.loadData("TestSet","ScheduleState",["PlanEstimate","ScheduleState"],["Accepted","Released"])};console.log(t),this.drawScreen(t)},reduceToFinishedItems:function(t,e,a){return t.reduce((t,s)=>{const i=s.data,n=t=>isNaN(t)||0===t.length?0:t,o=parseFloat(i.PlanEstimate),r=isNaN(o)?0:o,l=n(i.TaskActualTotal),c=n(i.TaskEstimateTotal),d=n(i.TaskRemainingTotal),u={...t,totalPoints:t.totalPoints+r,totalCount:t.totalCount+1,taskActuals:t.taskActuals+l,taskEstimates:t.taskEstimates+c,taskTodo:t.taskTodo+d};return a.includes(i[e])&&(u.points=t.points+r,u.count=t.count+1),u},{points:0,count:0,totalPoints:0,totalCount:0,taskActuals:0,taskEstimates:0,taskTodo:0})},onTimeboxScopeChange:function(t){const e=t||this.getContext().getTimeboxScope();this.timeboxFilters=e.getQueryFilter(),this.release=e.getRecord(),this.cleanHtml(),this.loadAllData()},_onReleaseChange:function(){this.timeboxFilters=this.releasecombo.getQueryFromSelected(),this.release=this.releasecombo.getRecord(),this.cleanHtml(),this.loadAllData()},createElement:function(t,e,a,s){const i=document.createElement(t);return a&&i.setAttribute("class",a),s&&i.setAttribute("id",s),e&&(i.textContent=e),i},drawScreen:function(t){const e=Ext.getBody().query("div span div")[0],a=this.createElement("div","","","main-box");e.appendChild(a);const{defects:s,testSets:i,stories:n}=t,o=s.points+i.points+n.points,r=s.totalPoints+i.totalPoints+n.totalPoints,l=s.count+i.count+n.count,c=s.totalCount+i.totalCount+n.totalCount,d=this.createElement("div",this.release.data.Name,"label center pad");a.appendChild(d);const u=`${this.release.data.formattedStartDate} - ${this.release.data.formattedEndDate}`,h=this.createElement("div",u,"center");a.appendChild(h);const m=this.createElement("div","","row space");a.appendChild(m),this.drawStatusBox(m,"Points",o,r),this.drawStatusBox(m,"Count",l,c);const p=(t,e)=>{const a=this.createElement("div","","row center tasks"),s=this.createElement("label",t,"right small-label"),i=this.createElement("div",e+"","left value");return a.appendChild(s),a.appendChild(i),a},f=p("Task Actuals:",s.taskActuals+i.taskActuals+n.taskActuals),C=p("Task Estimates:",s.taskEstimates+i.taskEstimates+n.taskEstimates),g=p("Task Todo:",s.taskTodo+i.taskTodo+n.taskTodo),b=this.createElement("div","","row center-justify pad");b.appendChild(f),b.appendChild(C),b.appendChild(g),a.appendChild(b)},drawStatusBox:function(t,e,a,s){const i=this.createElement("div","","stat-box center");t.appendChild(i);const n=this.createElement("div",e,"center label");i.appendChild(n);const o=this.createProgressMeter(80,10,a,s),r=this.createCircleDiv(80,10),l=this.createElement("div","","center","svg-div");i.appendChild(l);const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("width",80),c.setAttribute("height",80),c.appendChild(r),c.appendChild(o),l.appendChild(c);const d=0===a?0:Math.floor(a/s*100),u=this.createElement("div",`${a}/${s} Finished`,"center summary"),h=this.createElement("div",`${d}%`,"percent");i.appendChild(u),i.appendChild(h)},calculateUnrefiendValues:function(t,e){const a=e*(2*Math.PI);return{theta:a,x:t*Math.cos(a),y:t*Math.sin(a)}},createCircleDiv:function(t,e){const a=document.createElementNS("http://www.w3.org/2000/svg","circle");return a.setAttribute("r",t/2),a.setAttribute("cx",t/2+e),a.setAttribute("cy",t/2+e),a.setAttribute("stroke","lightgray"),a.setAttribute("fill","none"),a.setAttribute("stroke-width",3),a},createProgressMeter:function(t,e,a,s){return a===s?this.createDoneCircle(t,e):this.createPartialDoneCircle(t,e,a,s)},createDoneCircle:function(t,e){const a=document.createElementNS("http://www.w3.org/2000/svg","circle");return a.setAttribute("r",t/2),a.setAttribute("cx",t/2+e),a.setAttribute("cy",t/2+e),a.setAttribute("stroke","#57c282"),a.setAttribute("fill","none"),a.setAttribute("stroke-width",8),a},createPartialDoneCircle:function(t,e,a,s){const i=t/2,n=a/s,{theta:o,x:r,y:l}=this.calculateUnrefiendValues(i,n),{mX:c,mY:d,longSweep:u}=this.modifyArcCoordinates(i,e,o,r,l),h=document.createElementNS("http://www.w3.org/2000/svg","path");return h.setAttribute("d",`M ${e} ${e+i} A ${i} ${i} 0 ${u} 1 ${c} ${d}`),h.setAttribute("stroke","#5691f0"),h.setAttribute("stroke-width",8),h.setAttribute("stroke-linecap","round"),h.setAttribute("fill","none"),h},isQuadrant:function(t,e){const a=Math.PI/2;return t>=(e-1)*a&&t<e*a},cleanHtml:function(){const t=Ext.get("main-box");if(t){t.dom.parentNode.removeChild(t.dom)}},modifyArcCoordinates:function(t,e,a,s,i){return this.isQuadrant(a,1)?this.modifyQ1(t,e,s,i):this.isQuadrant(a,2)?this.modifyQ2(t,e,s,i):this.isQuadrant(a,3)?this.modifyQ3(t,e,s,i):this.modifyQ4(t,e,s,i)},modifyQ1:function(t,e,a,s){return{mX:t-a+e,mY:t-s+e,longSweep:0}},modifyQ2:function(t,e,a,s){return{mX:-1*(a-t)+e,mY:t-s+e,longSweep:0}},modifyQ3:function(t,e,a,s){return{mX:-1*(a-t)+e,mY:-1*(s-t)+e,longSweep:1}},modifyQ4:function(t,e,a,s){return{mX:t-a+e,mY:-1*(s-t)+e,longSweep:1}}});

            Rally.launchApp('CustomApp', {
                name:"ReleaseSummary",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .app #main-box{position:relative}.app #svg-div{height:100px;width:100px;margin:auto}.app svg{height:100%;width:100%;display:block}.app .center{text-align:center;justify-content:center}.app .center-justify{justify-content:center}.app .label{font-weight:bold;font-size:large}.app .left{padding-left:4px}.app .pad{padding:8px}.app .percent{font-size:24px;position:absolute;text-align:center;padding-top:6px;width:100%}.app .row{display:flex;flex-direction:row}.app .small-label{font-size:small;align-content:center}.app .space{justify-content:space-around}.app .stat-box{flex-grow:1;display:flex;flex-direction:column;position:relative}.app .summary{font-size:16px}.app .tasks{padding:8px}.app .value{font-size:medium;font-weight:bold}
    </style>
</head>
<body>
</body>
</html>
